{% extends "home.html" %}
{% block content %}
<script type="text/javascript" src="../static/jquery-1.11.3.js"></script>
<script type="text/javascript" src="../static/jquery.legit.js"></script>
<script type="text/javascript" src="../static/loader.js"></script>
<script type=text/javascript>
  $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};
</script>

<script type=text/javascript>
  $(function() {
    $('a#chartHere').bind('click', function() {
      $.getJSON($SCRIPT_ROOT + '/handleQuery', {
        type: $('input[name="type"]').val(),
        recipientName: $('input[name="recipientName"]').val(),
        recipientEmail: $('input[name="recipientEmail"]').val(),
        creator: $('input[name="creator"]').val(),
        date: $('input[name="date"]').val(),
        chartType: $('input[name="chartType"]').val()
      }, function(data) {
        // $("#result").text(results.result);
        console.log(data);
        var results = data['final']['query'];
        var users = data.final.users;
        console.log(results);
        console.log(users);

        google.charts.load('current', {'packages':['corechart', 'table']});

        // Set a callback to run when the Google Visualization API is loaded.
        google.charts.setOnLoadCallback(drawChart);

        // Callback that creates and populates a data table,
        // instantiates the pie chart, passes in the data and draws it.
        function drawChart() {

          var tableData = new google.visualization.DataTable(results);
          console.log("Results", results);
          tableData.addColumn('string', 'Recipient Name');
          tableData.addColumn('string', 'Recipient Email');
          tableData.addColumn('string', 'Award Type');
          tableData.addColumn('date', 'Date');

          for(var j=0; j<users.length; j++){
            users[j].numAwards = 0;
          }

          for(var i=0;i<results.length; i++){
              var t = results[i].date.split(/[- :]/);
              var d = new Date(t[0], t[1]-1, t[2], t[3], t[4], t[5]);
              tableData.addRow([results[i].recipientName, results[i].recipientEmail, results[i].type, d] );
          }

          console.log(users);
          var chartData = new google.visualization.DataTable(results);
          chartData.addColumn('string', 'Recipient Name');
          chartData.addColumn('number', 'Number of Awards');

          for(var i=0;i<results.length; i++){
            for(j=0;j<users.length;j++){
              if(users[j].username == results[i].recipientEmail)
                users[j].numAwards++;
            }
          }
          for(i=0;i<users.length;i++){
            chartData.addRow([users[i].username, users[i].numAwards]);
          }

          // Set chart options
          var options = {'title':'Number of Awards Per Person',
                         'width':600,
                         'height':450};

          // Show results in a chart of the user's choice
          var chart = new google.visualization.PieChart(document.getElementById('chart_div'));
          chart.draw(chartData, options);

          // Show results in a table
          var table = new google.visualization.Table(document.getElementById('table_div'));
          table.draw(tableData, {showRowNumber: true, width: '70%', height: '100%'});
        }

        });
        return false;
      });
  });
</script>
<div class="container col-xs-6">
  <h3 class="text-muted">Query</h3>
  <p>Search by any of the following parameters. An empty search will return all awards.</p>
<form class="form-horizontal">
  <div class="form-group">
    <label for="type" class="col-sm-4 control-label">Award Type</label>
    <div class="col-sm-6">
      <input type="text" class="form-control" id="type" name="type" placeholder="Award Type">
    </div>
  </div>
  <div class="form-group">
    <label for="recipientName" class="col-sm-4 control-label">Recipient Name</label>
    <div class="col-sm-6">
      <input type="text" class="form-control" id="recipientName" placeholder="Recipient Name" name="recipientName">
    </div>
  </div>
  <div class="form-group">
    <label for="recipientEmail" class="col-sm-4 control-label">Recipient Email</label>
    <div class="col-sm-6">
      <input type="text" class="form-control" id="recipientEmail" placeholder="Recipient Email" name="recipientEmail">
    </div>
  </div>
  <div class="form-group">
    <label for="creator" class="col-sm-4 control-label">Creator</label>
    <div class="col-sm-6">
      <input type="text" class="form-control" id="creator" placeholder="Creator" name="creator">
    </div>
  </div>
  <div class="form-group">
    <label for="date" class="col-sm-4 control-label">Date</label>
    <div class="col-sm-6">
      <input type="text" class="form-control" id="date" placeholder="Date" name="date">
    </div>
  </div>
  <div class="form-group">
    <label for="chartType" class="col-sm-4 control-label">Chart Type</label>
    <div class="col-sm-6">
      <input type="text" class="form-control" id="chartType" placeholder="Chart Type" name="chartType">
    </div>
  </div>
  <div class="form-group">
    <label for="sort" class="col-sm-4 control-label">Sort By:</label>
    <div class="col-sm-6">
      <input type="text" class="form-control" id="sort" placeholder="Sort" name="sort">
    </div>
  </div>
  <div class="form-group">
    <div class="col-sm-offset-2 col-sm-4"><a id="chartHere">
      <button type="submit" class="btn btn-default">Get Results</button></a>
    </div>
  </div>
</form>
<span id="result"></span>

</div>

<div class="container col-xs-6">
  <div id="chart_div"></div>
</div>
<div class="container col-xs-12">
  <h3>All Awards</h3>
  <div id="table_div"></div>
</div>



<div class="container">
</div>


{% endblock %}
